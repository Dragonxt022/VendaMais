<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= typeof title !== 'undefined' ? title : 'Painel do Cliente - VendaMais' %></title>
    <link rel="stylesheet" href="/stylesheets/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="/uploads/icon/favicon.png">
</head>
<body class="bg-slate-50 font-sans antialiased text-slate-900">
    <div class="flex min-h-screen">
        <!-- Sidebar Overlay (Mobile) -->
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-40 hidden md:hidden transition-opacity"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="fixed md:sticky top-0 left-0 w-64 bg-white border-r border-slate-200 flex flex-col h-screen z-50 transition-transform -translate-x-full md:translate-x-0">
            <div class="p-6 flex items-center justify-between">
                <a href="/" class="text-xl font-bold text-food-orange flex items-center gap-2">
                    <span class="w-8 h-8 bg-food-orange rounded-lg"></span>
                    VendaMais
                </a>
                <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-slate-600">×</button>
            </div>
            
            <nav id="user-nav" class="flex-1 px-4 space-y-1 mt-4">
                <a href="/app" data-nav-link class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-xl transition-colors">
                    <span><img class="w-6 h-6" src="/uploads/icon/home.svg" alt="icon"></span> Dashboard
                </a>
                <details class="group" id="stock-menu">
                    <summary class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-xl transition-colors cursor-pointer list-none select-none">
                        <span><img class="w-6 h-6" src="/uploads/icon/box.svg" alt="icon"></span> <span class="flex-1 font-medium">Estoque</span>
                        <img src="/uploads/icon/seta_raw.svg" class="w-3 h-3 transition-transform group-open:rotate-90" alt="">
                    </summary>
                    <div class="pl-4 pr-2 space-y-1 mt-1 mb-2">
                        <a href="/app/products" data-nav-link class="flex items-center gap-2 px-4 py-2 text-sm text-slate-500 rounded-lg hover:text-food-orange hover:bg-orange-50 transition-colors">
                            Inventário
                        </a>
                        <a href="/app/categories" data-nav-link class="flex items-center gap-2 px-4 py-2 text-sm text-slate-500 rounded-lg hover:text-food-orange hover:bg-orange-50 transition-colors">
                            Categorias
                        </a>
                        <a href="/app/suppliers" data-nav-link class="flex items-center gap-2 px-4 py-2 text-sm text-slate-500 rounded-lg hover:text-food-orange hover:bg-orange-50 transition-colors">
                            Fornecedores
                        </a>
                    </div>
                </details>
            </nav>

            <div class="p-4 border-t border-slate-100">
                <a href="/logout" class="flex items-center gap-3 px-4 py-3 text-red-500 hover:bg-red-50 rounded-xl transition-colors font-medium">
                    <span><img class="w-6 h-6" src="/uploads/icon/door.svg" alt="icon"></span> Sair
                </a>
            </div>
        </aside>

        <!-- Content Area -->
        <div class="flex-1 flex flex-col min-w-0">
            <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 md:px-8 sticky top-0 z-10">
                <button onclick="toggleSidebar()" class="md:hidden text-slate-500 text-xl p-2 hover:bg-slate-50 rounded-lg">☰</button>
                <a href="/app/profile" class="flex items-center gap-4 ml-auto hover:opacity-80 transition-opacity">
                    <div class="text-right hidden sm:block">
                        <p class="text-xs text-slate-400 font-bold uppercase">Bem-vindo(a)</p>
                        <p class="text-sm font-bold text-slate-900"><%= user && (user.name || user.username) %></p>
                    </div>
                    <div class="w-10 h-10 bg-slate-100 rounded-xl border border-slate-200 flex items-center justify-center text-food-orange font-bold text-lg overflow-hidden shadow-sm">
                        <% if (user && user.avatar) { %>
                            <img src="<%= user.avatar %>" alt="Avatar" class="w-full h-full object-cover">
                        <% } else { %>
                            <%= user ? (user.name || user.username).charAt(0).toUpperCase() : 'U' %>
                        <% } %>
                    </div>
                </a>
            </header>
            
            <main class="p-4 md:p-8">
                <%- body %>
            </main>
        </div>
    </div>

    <%- include('../../partials/ui/toast') %>

    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isHidden = sidebar.classList.contains('-translate-x-full');

            if (isHidden) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        // Improved active state manager
        function updateActiveLinks() {
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('[data-nav-link]');
            
            navLinks.forEach(link => {
                const href = link.getAttribute('href');
                
                // Match exact path OR start of path (for sub-routes)
                // We want exact match for dashboard /app, but start-match for /app/products
                const isExact = href === currentPath;
                const isSubRoute = href !== '/app' && currentPath.startsWith(href);

                if (isExact || isSubRoute) {
                    // Reset styling first
                    link.classList.remove('text-slate-500', 'hover:bg-slate-50');
                    
                    // Add active styling
                    link.classList.add('text-food-orange', 'bg-orange-50', 'font-bold');
                    
                    // If inside details, open it
                    const details = link.closest('details');
                    if (details) {
                        details.open = true;
                        details.querySelector('summary').classList.add('text-food-orange', 'font-bold');
                        details.querySelector('summary').classList.remove('text-slate-500');
                    }
                }
            });
        }

        // Run on load
        document.addEventListener('DOMContentLoaded', updateActiveLinks);
    </script>
</body>
</html>
