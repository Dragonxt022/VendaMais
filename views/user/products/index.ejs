<div class="mb-8 p-1">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-slate-900">Meu Estoque</h1>
            <p class="text-slate-500 text-sm mt-1">Gerencie seu invent√°rio de forma eficiente</p>
        </div>
        <div class="flex items-center gap-3">
            <div id="bulkActions" class="hidden flex items-center gap-2 bg-orange-50 px-4 py-2 rounded-2xl border border-orange-100 animate-in fade-in slide-in-from-right-4 duration-300">
                <span class="text-xs font-bold text-food-orange mr-2" id="bulkSelectedCount"></span>
                <button onclick="openBulkAdjustModal()" class="px-3 py-1.5 bg-white border border-orange-200 text-food-orange rounded-xl text-xs font-bold hover:bg-orange-50 transition-all">
                    ‚öñÔ∏è Reajuste
                </button>
                <button onclick="bulkDelete()" class="px-3 py-1.5 bg-white border border-red-100 text-red-500 rounded-xl text-xs font-bold hover:bg-red-50 transition-all">
                    üóëÔ∏è Excluir
                </button>
            </div>
            <%- include('../../partials/ui/button', { text: 'Registrar Movimento', variant: 'secondary', onclick: "toggleModal('moveModal')" }) %>
            <%- include('../../partials/ui/button', { text: 'Novo Produto', variant: 'primary', onclick: "resetProductModal(); toggleModal('productModal')" }) %>
        </div>
    </div>
    
    <!-- Controls Bar -->
    <div class="mt-8 flex flex-wrap items-center gap-4 bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
        <div class="relative flex-1 min-w-[300px]">
            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">üîç</span>
            <input 
                type="text" 
                id="productSearch" 
                placeholder="Buscar por nome ou SKU..." 
                value="<%= filters.search %>"
                class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-food-orange/20 focus:border-food-orange transition-all outline-none text-sm"
                onkeyup="handlePredictiveSearch(this.value)"
                onfocus="handlePredictiveSearch(this.value)"
            >
            <div id="searchResults" class="hidden absolute top-full left-0 right-0 mt-2 bg-white border border-slate-200 rounded-2xl shadow-2xl z-[100] max-h-80 overflow-y-auto">
                <!-- Results will be injected here -->
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-2">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Categoria:</span>
                <select id="categoryFilter" onchange="applyFilters()" class="pl-3 pr-8 py-2 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-food-orange/20 text-sm appearance-none cursor-pointer">
                    <option value="">Todas</option>
                    <% categories.forEach(cat => { %>
                        <option value="<%= cat.id %>" <%= filters.category_id == cat.id ? 'selected' : '' %>><%= cat.name %></option>
                    <% }) %>
                </select>
            </div>

            <div class="flex items-center gap-2">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Exibir:</span>
                <select id="limitSelector" onchange="applyFilters()" class="pl-3 pr-8 py-2 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-food-orange/20 text-sm appearance-none cursor-pointer">
                    <option value="20" <%= pagination.currentLimit == 20 ? 'selected' : '' %>>20</option>
                    <option value="50" <%= pagination.currentLimit == 50 ? 'selected' : '' %>>50</option>
                    <option value="100" <%= pagination.currentLimit == 100 ? 'selected' : '' %>>100</option>
                </select>
            </div>
        </div>
    </div>
</div>

<div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead class="bg-slate-50 border-b border-slate-200">
                <tr>
                    <th class="pl-6 py-4 w-10">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)" class="w-4 h-4 rounded border-slate-300 text-food-orange focus:ring-food-orange">
                    </th>
                    <th class="px-4 py-4 w-10"></th>
                    <th class="px-4 py-4 text-slate-500 font-semibold text-xs uppercase cursor-pointer" onclick="toggleSort('name')">
                        Produto <span class="ml-1 text-[10px]"><%= filters.sort === 'name' ? '‚ñ≤' : '' %></span>
                    </th>
                    <th class="px-6 py-4 text-slate-500 font-semibold text-xs uppercase">SKU</th>
                    <th class="px-6 py-4 text-slate-500 font-semibold text-xs uppercase">Categoria</th>
                    <th class="px-6 py-4 text-slate-500 font-semibold text-xs uppercase">Pre√ßo</th>
                    <th class="px-6 py-4 text-slate-500 font-semibold text-xs uppercase">Estoque</th>
                    <th class="px-6 py-4 text-slate-500 font-semibold text-xs uppercase text-right">A√ß√µes</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100" id="productTableBody">
                <% if (products.length > 0) { %>
                    <% products.forEach(product => { %>
                        <tr class="group hover:bg-slate-50/80 transition-all cursor-pointer" onclick="handleRowClick(event, '<%= product.id %>')">
                            <td class="pl-6 py-4" onclick="event.stopPropagation()">
                                <input type="checkbox" name="productSelect" value="<%= product.id %>" onchange="updateBulkUI()" class="w-4 h-4 rounded border-slate-300 text-food-orange focus:ring-food-orange">
                            </td>
                            <td class="px-4 py-4" onclick="event.stopPropagation()">
                                <button onclick="toggleFavorite('<%= product.id %>')" class="text-xl transition-transform hover:scale-125 focus:outline-none">
                                    <span id="fav-icon-<%= product.id %>" class="<%= product.is_favorite ? 'text-red-500' : 'text-slate-300 grayscale opacity-40 hover:opacity-100 hover:grayscale-0' %>">
                                        <%= product.is_favorite ? '‚ù§Ô∏è' : 'ü§ç' %>
                                    </span>
                                </button>
                            </td>
                            <td class="px-4 py-4">
                                <span class="font-medium text-slate-900 block"><%= product.name %></span>
                                <% if (product.Supplier) { %>
                                    <span class="text-[10px] text-slate-400 uppercase tracking-wider"><%= product.Supplier.name %></span>
                                <% } %>
                            </td>
                            <td class="px-6 py-4 text-slate-500 text-sm font-mono"><%= product.sku || '-' %></td>
                            <td class="px-6 py-4">
                                <% if (product.Category) { %>
                                    <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase" style="background-color: <%= product.Category.color %>20; color: <%= product.Category.color %>">
                                        <%= product.Category.name %>
                                    </span>
                                <% } else { %>
                                    <span class="text-slate-300 text-xs">-</span>
                                <% } %>
                            </td>
                            <td class="px-6 py-4 text-slate-900 text-sm font-semibold">R$ <%= product.price.toLocaleString('pt-BR', { minimumFractionDigits: 2 }) %></td>
                            <td class="px-6 py-4">
                                <% if (product.manage_stock) { %>
                                    <div class="flex flex-col">
                                        <span class="font-bold <%= product.stock_quantity <= product.min_stock ? 'text-red-500' : 'text-slate-900' %>">
                                            <%= product.stock_quantity %>
                                        </span>
                                        <span class="text-slate-400 text-[10px]">M√≠n: <%= product.min_stock %></span>
                                    </div>
                                <% } else { %>
                                    <span class="text-slate-300 text-xs">N/A</span>
                                <% } %>
                            </td>
                            <td class="px-6 py-4 text-right" onclick="event.stopPropagation()">
                                <div class="relative inline-block text-left">
                                    <button 
                                        onclick="toggleDropdown(event, 'dropdown-<%= product.id %>')"
                                        class="p-2 hover:bg-slate-200 rounded-full transition-colors focus:outline-none text-slate-400 hover:text-slate-600"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                                        </svg>
                                    </button>
                                    <div id="dropdown-<%= product.id %>" class="dropdown-menu hidden absolute right-0 mt-2 w-56 bg-white border border-slate-200 rounded-2xl shadow-2xl z-[60] py-2 overflow-hidden animate-in fade-in zoom-in-95 duration-100">
                                        <div class="px-4 py-2 border-b border-slate-50 mb-1">
                                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Op√ß√µes</p>
                                        </div>
                                        <button onclick="prepareEditModal('<%= product.id %>')" class="flex items-center gap-3 w-full px-4 py-2.5 text-sm text-slate-700 hover:bg-slate-50 transition-colors">
                                            <span>‚úèÔ∏è</span> Editar Produto
                                        </button>
                                        <button onclick="prepareMoveModal('<%= product.id %>')" class="flex items-center gap-3 w-full px-4 py-2.5 text-sm text-slate-700 hover:bg-slate-50 transition-colors">
                                            <span>üì¶</span> Ajustar Estoque
                                        </button>
                                        <button onclick="duplicateProduct('<%= product.id %>')" class="flex items-center gap-3 w-full px-4 py-2.5 text-sm text-slate-700 hover:bg-slate-50 transition-colors">
                                            <span>üìã</span> Duplicar Item
                                        </button>
                                        <a href="/app/products/<%= product.id %>/history" class="flex items-center gap-3 w-full px-4 py-2.5 text-sm text-slate-700 hover:bg-slate-50 transition-colors">
                                            <span>üï∞Ô∏è</span> Hist√≥rico de Estoque
                                        </a>
                                        <button onclick="toggleFavorite('<%= product.id %>')" class="flex items-center gap-3 w-full px-4 py-2.5 text-sm text-slate-700 hover:bg-slate-50 transition-colors">
                                            <span id="fav-btn-icon-<%= product.id %>"><%= product.is_favorite ? 'üíî' : '‚ù§Ô∏è' %></span> 
                                            <span id="fav-btn-text-<%= product.id %>">
                                                <%= product.is_favorite ? 'Remover Favorito' : 'Favoritar' %>
                                            </span>
                                        </button>
                                        <div class="border-t border-slate-100 mt-1 pt-1">
                                            <button onclick="deleteProduct('<%= product.id %>')" class="flex items-center gap-3 w-full px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 transition-colors">
                                                <span>üóëÔ∏è</span> Excluir Produto
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Hidden data for edit modal -->
                                <div id="product-data-<%= product.id %>" class="hidden" 
                                    data-id="<%= product.id %>"
                                    data-name="<%= product.name %>"
                                    data-sku="<%= product.sku %>"
                                    data-price="<%= product.price %>"
                                    data-cost="<%= product.cost %>"
                                    data-min-stock="<%= product.min_stock %>"
                                    data-manage-stock="<%= product.manage_stock %>"
                                    data-category-id="<%= product.category_id %>"
                                    data-supplier-id="<%= product.supplier_id %>">
                                </div>
                            </td>
                        </tr>
                    <% }); %>
                <% } else { %>
                    <tr>
                        <td colspan="8" class="px-6 py-20 text-center">
                            <div class="flex flex-col items-center">
                                <span class="text-4xl mb-4">üì¶</span>
                                <h3 class="text-slate-900 font-semibold">Nenhum produto encontrado</h3>
                                <p class="text-slate-400 text-sm">Tente ajustar seus filtros ou busca.</p>
                            </div>
                        </td>
                    </tr>
                <% } %>
            </tbody>
        </table>
    </div>

    <!-- Pagination Footer -->
    <% if (pagination.pages > 1) { %>
        <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex items-center justify-between">
            <div class="text-sm text-slate-500">
                Mostrando <span class="font-medium text-slate-900"><%= products.length %></span> de <span class="font-medium text-slate-900"><%= pagination.total %></span> resultados
            </div>
            <div class="flex gap-2">
                <button 
                    onclick="changePage(<%= pagination.currentPage - 1 %>)"
                    <%= pagination.currentPage === 1 ? 'disabled' : '' %>
                    class="px-3 py-1.5 rounded-lg border border-slate-300 text-slate-700 bg-white hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                >
                    Anterior
                </button>
                
                <div class="flex items-center gap-1">
                    <% for(let i = 1; i <= pagination.pages; i++) { %>
                        <% if (i === 1 || i === pagination.pages || (i >= pagination.currentPage - 1 && i <= pagination.currentPage + 1)) { %>
                            <button 
                                onclick="changePage(<%= i %>)"
                                class="w-10 h-10 rounded-lg flex items-center justify-center font-medium transition-colors <%= pagination.currentPage === i ? 'bg-food-orange text-white' : 'hover:bg-slate-200 text-slate-700' %>"
                            >
                                <%= i %>
                            </button>
                        <% } else if (i === pagination.currentPage - 2 || i === pagination.currentPage + 2) { %>
                            <span class="text-slate-400 mx-1">...</span>
                        <% } %>
                    <% } %>
                </div>

                <button 
                    onclick="changePage(<%= pagination.currentPage + 1 %>)"
                    <%= pagination.currentPage === pagination.pages ? 'disabled' : '' %>
                    class="px-3 py-1.5 rounded-lg border border-slate-300 text-slate-700 bg-white hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                >
                    Pr√≥ximo
                </button>
            </div>
        </div>
    <% } %>
</div>

<!-- Bulk Adjust Modal -->
<%- include('../../partials/modals/bulk_adjust_modal') %>

<style>
    .dropdown:hover .dropdown-menu {
        display: block;
    }
</style>

<!-- Modais -->
<%- include('../../partials/modals/product_modal') %>
<%- include('../../partials/modals/move_modal') %>
<%- include('../../partials/modals/quick_category_modal') %>
<%- include('../../partials/modals/quick_supplier_modal') %>

<!-- Scripts -->
<%- include('../../partials/shared/products_scripts') %>

